<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<link href="http://fonts.googleapis.com/css?family=Rosarivo:400,400italic|Happy+Monkey|Electrolize" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link rel="previous" href="Net.html">
<link rel="next" href="Packet.html">
<link rel="Up" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Arp" rel="Chapter" href="Arp.html">
<link title="Browser" rel="Chapter" href="Browser.html">
<link title="Clock" rel="Chapter" href="Clock.html">
<link title="Dhcp" rel="Chapter" href="Dhcp.html">
<link title="Dhcpd" rel="Chapter" href="Dhcpd.html">
<link title="Dns" rel="Chapter" href="Dns.html">
<link title="Eth" rel="Chapter" href="Eth.html">
<link title="Host" rel="Chapter" href="Host.html">
<link title="Html" rel="Chapter" href="Html.html">
<link title="Http" rel="Chapter" href="Http.html">
<link title="Hub" rel="Chapter" href="Hub.html">
<link title="Icmp" rel="Chapter" href="Icmp.html">
<link title="Icmp6" rel="Chapter" href="Icmp6.html">
<link title="Ip" rel="Chapter" href="Ip.html">
<link title="Ip6" rel="Chapter" href="Ip6.html">
<link title="Localhost" rel="Chapter" href="Localhost.html">
<link title="Log" rel="Chapter" href="Log.html">
<link title="Metric" rel="Chapter" href="Metric.html">
<link title="Myadmin" rel="Chapter" href="Myadmin.html">
<link title="Net" rel="Chapter" href="Net.html">
<link title="Opache" rel="Chapter" href="Opache.html">
<link title="Packet" rel="Chapter" href="Packet.html">
<link title="Pcap" rel="Chapter" href="Pcap.html">
<link title="Peg" rel="Chapter" href="Peg.html">
<link title="Persist" rel="Chapter" href="Persist.html">
<link title="Router" rel="Chapter" href="Router.html">
<link title="Sim" rel="Chapter" href="Sim.html">
<link title="Sll" rel="Chapter" href="Sll.html">
<link title="Tcp" rel="Chapter" href="Tcp.html">
<link title="Tools" rel="Chapter" href="Tools.html">
<link title="Udp" rel="Chapter" href="Udp.html">
<link title="Url" rel="Chapter" href="Url.html">
<link title="Vlan" rel="Chapter" href="Vlan.html"><link title="HTTP servicing functions" rel="Section" href="#2_HTTPservicingfunctions">
<title>Opache</title>
</head>
<body>
<div class="navbar"><a class="pre" href="Net.html" title="Net">Previous</a>
&nbsp;<a class="up" href="index.html" title="Index">Up</a>
&nbsp;<a class="post" href="Packet.html" title="Packet">Next</a>
</div>
<h1>Module <a href="type_Opache.html">Opache</a></h1>
<pre><span class="keyword">module</span> Opache: <code class="code"><span class="keyword">sig</span></code> <a href="Opache.html">..</a> <code class="code"><span class="keyword">end</span></code></pre><div class="info">
A simple HTTP server.<br>
</div>
<hr width="100%">
<pre><span id="VALparams_of_query"><span class="keyword">val</span> params_of_query</span> : <code class="type">string -> (string, string) Batteries.Hashtbl.t</code></pre><pre><span id="VALstripped"><span class="keyword">val</span> stripped</span> : <code class="type">string -> string</code></pre><pre><span id="VALserve"><span class="keyword">val</span> serve</span> : <code class="type"><a href="Host.html#TYPEhost_trx">Host.host_trx</a> -><br>       Tcp.Port.t -> (<a href="Http.TRXtop.html#TYPEt">Http.TRXtop.t</a> -> <a href="Http.Pdu.html#TYPEt">Http.Pdu.t</a> -> <a href="Log.html#TYPElogger">Log.logger</a> -> 'a) -> unit</code></pre><div class="info">
Listen HTTP connections arriving at <code class="code">host</code> on given <code class="code">port</code>,
  passing incoming messages to a user supplied function <code class="code">f</code>.
<p>

  A simple server may be used like:
<p>

  <pre class="codepre"><code class="code">&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Server&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;server&nbsp;=&nbsp;<span class="constructor">Host</span>.make_static&nbsp;<span class="string">"server"</span>&nbsp;(<span class="constructor">Eth</span>.<span class="constructor">Addr</span>.random&nbsp;())&nbsp;(<span class="constructor">Ip</span>.<span class="constructor">Addr</span>.of_string&nbsp;<span class="string">"192.168.1.1"</span>);;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;content_of&nbsp;file&nbsp;=&nbsp;<span class="constructor">File</span>.lines_of&nbsp;file&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.of_enum&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;<span class="string">""</span>;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Opache</span>.serve&nbsp;server&nbsp;(<span class="constructor">Tcp</span>.<span class="constructor">Port</span>.o&nbsp;8080)&nbsp;(<span class="keyword">fun</span>&nbsp;trx&nbsp;_msg&nbsp;_log&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Http</span>.<span class="constructor">TRXtop</span>.tx&nbsp;trx&nbsp;(<span class="constructor">Http</span>.<span class="constructor">Pdu</span>.make_status&nbsp;200&nbsp;[<span class="string">"Content-Type"</span>,&nbsp;<span class="string">"text/plain"</span>]&nbsp;(content_of&nbsp;<span class="string">"test.ml"</span>)));;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Our&nbsp;client&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;client&nbsp;=&nbsp;<span class="constructor">Host</span>.make_static&nbsp;<span class="string">"client"</span>&nbsp;(<span class="constructor">Eth</span>.<span class="constructor">Addr</span>.random&nbsp;())&nbsp;(<span class="constructor">Ip</span>.<span class="constructor">Addr</span>.of_string&nbsp;<span class="string">"192.168.1.2"</span>);;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;browser&nbsp;=&nbsp;<span class="constructor">Browser</span>.make&nbsp;client;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Link&nbsp;with&nbsp;a&nbsp;tap&nbsp;in&nbsp;between&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tap&nbsp;=&nbsp;<span class="constructor">Hub</span>.<span class="constructor">Tap</span>.make&nbsp;(<span class="constructor">Pcap</span>.save&nbsp;<span class="string">"http.pcap"</span>);;<br>
&nbsp;&nbsp;&nbsp;&nbsp;client.<span class="constructor">Host</span>.dev&nbsp;&lt;--&gt;&nbsp;tap.ins&nbsp;;&nbsp;tap.out&nbsp;&lt;--&gt;&nbsp;server.<span class="constructor">Host</span>.dev;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Send&nbsp;a&nbsp;request&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Browser</span>.request&nbsp;browser&nbsp;~headers:[<span class="string">"Connection"</span>,&nbsp;<span class="string">"close"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Url</span>.of_string&nbsp;<span class="string">"http://192.168.1.1:8080/"</span>)&nbsp;(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Printf</span>.printf&nbsp;<span class="string">"fail\n"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(headers,&nbsp;body)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Printf</span>.printf&nbsp;<span class="string">"\nResult:\n%a\n\n%s\n"</span>&nbsp;<span class="constructor">Http</span>.print_headers&nbsp;headers&nbsp;body);;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Clock</span>.run&nbsp;<span class="keyword">false</span>;;<br>
&nbsp;&nbsp;</code></pre>
<p>

  Notice that this example, if copied into test.ml, will generate a pcap containing the source code that
  generates the pcap :-)<br>
</div>
<br>
<h2 id="2_HTTPservicingfunctions">HTTP servicing functions</h2>
  These functions build a function taking an , an incomming  and
  responsible for sending the answer. They are mean to be used by <code class="code">multiplexer</code>.<br>
<pre><span id="VALprint_vars"><span class="keyword">val</span> print_vars</span> : <code class="type">'a BatInnerIO.output -> (string, string) Batteries.Hashtbl.t -> unit</code></pre><pre><span id="EXCEPTIONResourceError"><span class="keyword">exception</span> ResourceError</span> <span class="keyword">of</span> <code class="type">int * string</code></pre>
<pre><span id="VALcontent_type_from_filename"><span class="keyword">val</span> content_type_from_filename</span> : <code class="type">string -> string</code></pre><pre><span id="VALstatic_file_server"><span class="keyword">val</span> static_file_server</span> : <code class="type">string -><br>       'a -> string list -> 'b -> 'c -> 'd BatIO.output -> (string * string) list</code></pre><pre><span id="VALit_works"><span class="keyword">val</span> it_works</span> : <code class="type">'a -><br>       string list -> 'b -> 'c -> 'd BatInnerIO.output -> (string * string) list</code></pre><pre><span id="TYPEparams"><span class="keyword">type</span> <code class="type"></code>params</span> = <code class="type">(string, string) Batteries.Hashtbl.t</code> </pre>

<pre><span id="TYPEresource"><span class="keyword">type</span> <code class="type"></code>resource</span> = <code class="type">(Str.regexp *<br>        (string -><br>         string list -><br>         <a href="Opache.html#TYPEparams">params</a> -> string -> string BatIO.output -> <a href="Http.html#TYPEheader">Http.header</a> list))<br>       list</code> </pre>

<pre><span id="VALmultiplexer"><span class="keyword">val</span> multiplexer</span> : <code class="type"><a href="Opache.html#TYPEresource">resource</a> -> <a href="Http.TRXtop.html#TYPEt">Http.TRXtop.t</a> -> <a href="Http.Pdu.html#TYPEt">Http.Pdu.t</a> -> <a href="Log.html#TYPElogger">Log.logger</a> -> unit</code></pre></body></html>